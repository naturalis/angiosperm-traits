---
title: "Pipeline_myco"
output: html_document
---

```{r setup, i---
title: "Pipeline"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Pipeline of the necessary steps in R and outside of R

## 1 Import data

First the traits table and the original tree have to be read into R in the right format to be able to use them. 

### The project root and the main tree
```{r define data root and import tree}
#load required package
library(ape)

#import and define data
project_root <- 'C:/Users/Esther/Documents/Master/Stage/'
tree_file <- paste(c(project_root, 'ALLMB.tre'), collapse = '')
tree <- read.tree(tree_file)
```

### Import mycorrhiza data
```{r import mycorrhiza data}
#import and define trait table 
myco_tsv_file <- paste(c(project_root, 'sdmdl-angiosperm-data/data/myco_taxa.tsv'), collapse = '')
myco_tsv <- read.table(myco_tsv_file, sep = '\t', header = TRUE)
```

## 3 Recode dependent variables to binary form

The data of the dependent characters (the plant traits) have to be recoded. This is because a binary 
input is prefered for this analysis due to technical reasons, while all the data has 3 or 4 states at the
moment. 

For mycorrhiza, there are 4 trait-states: EM, AM, both, neither. This will be turned into: AM (0) and 
the rest together (1). So in this case nothing will be eliminated from the analysis, just (1)(2)(3) have 
to be collapsed together. 
```{r collapse state 1, 2 and 3}
#create new column
myco_tsv["myco_state_int"] <- NA

#add binary values to column based on names 
myco_tsv$myco_state_int[myco_tsv$myco_state == "arbuscular"] <- "0"
myco_tsv$myco_state_int[myco_tsv$myco_state == "ecto"] <- "1"
myco_tsv$myco_state_int[myco_tsv$myco_state == "both"] <- "1"
myco_tsv$myco_state_int[myco_tsv$myco_state == "neither"] <- "1"

#now myco_tsv_bi contains an added column with binary state values
```

## 4 Tidy data

### Trim the tree 
The tree and the traits-tables have to match, but there are plants in the phylogeny (tree) that are 
not in the traits table -> cut these out of the tree. It could be true that the taxa names don't 
match between the tree file and the trait-table, in that case not the same amount of taxa will still
be in the tree as there are in the trait table. If that is the case, this has to be fixed!

```{r trim tree}
#load required packages and data
library(stringi)

#define the temporary tree for mycorrhiza
keep_tips_myco_tsv_bi <- as.character(unlist(c(myco_tsv[1]))) 
keep_tips_myco_tsv_bi <- stri_replace_all_charclass(keep_tips_myco_tsv_bi, "\\p{WHITE_SPACE}", "_")

tips_to_drop_myco <- setdiff(tree$tip.label, keep_tips_myco_tsv_bi)
tree_myco_tsv <- drop.tip(tree, tips_to_drop_myco)
```

### Match the names 
Make the taxa names the same in the table as in the tree. 
```{r match names}
#replace the spaces in the taxa names for _ 
myco_tsv$allmb_name <- stri_replace_all_charclass(myco_tsv$allmb_name, "\\p{WHITE_SPACE}", "_")
```

## 5 Combine the data

The trait states, the selected subset of taxa names, and the GIS information all have to be combined into one file. 

### Import GIS data
Import the data and make sure the taxa names are the same in this table as in the tsv file and in the tree file,
so with _ instead of spaces 
```{r import GIS data}
#import GIS data 
GIS_file <- paste(c(project_root, 'niche_traits_merged.csv'), collapse = '')
GIS <- read.table(GIS_file, sep = ',', header = TRUE)

#change names of GIS data 
GIS_names <- as.character(unlist(c(GIS[1])))
GIS_names <- gsub('  ', '. ', GIS_names)
GIS_names <- stri_replace_all_charclass(GIS_names, "\\p{WHITE_SPACE}", "_")

#there is a discrepancy with several names that should have a - instead of a _ in some places. 
#So we have to change those specific GIS names:
GIS_names[GIS_names == "Acaena_novae_zelandiae"] <- "Acaena_novae-zelandiae"
GIS_names[GIS_names == "Impatiens_noli_tangere"] <- "Impatiens_noli-tangere"  
GIS_names[GIS_names == "Myrrhidendron_donnell_smithii" ] <- "Myrrhidendron_donnell-smithii" 
GIS_names[GIS_names == "Silene_flos_cuculi"] <- "Silene_flos-cuculi"
GIS_names[GIS_names == "Pithecellobium_unguis_cati"] <- "Pithecellobium_unguis-cati"
GIS_names[GIS_names == "Hyacinthoides_non_scripta" ] <- "Hyacinthoides_non-scripta" 
GIS_names[GIS_names == "Alisma_plantago_aquatica"] <- "Alisma_plantago-aquatica" 
GIS_names[GIS_names == "Apera_spica_venti"] <- "Apera_spica-venti"
GIS_names[GIS_names == "Arctostaphylos_uva_ursi"] <- "Arctostaphylos_uva-ursi"
GIS_names[GIS_names == "Blitum_bonus_henricus"] <- "Blitum_bonus-henricus"
GIS_names[GIS_names == "Begonia_meyeri_johannis"] <- "Begonia_meyeri-johannis"
GIS$allmb_name <- GIS_names
```

### Tidy data
Make the right selection of taxa out of the GIS variables table and the tree. 
```{r trim GIS table}
#select the taxa that should be kept in the GIS file
keep_GIS_myco <- as.character(unlist(c(myco_tsv[1]))) 
#define the final GIS file for mycorrhiza
GIS_myco <- GIS[GIS$allmb_name %in% keep_GIS_myco,]

#select the names that have to be kept in the tree
keep_tips_myco <- as.character(unlist(c(GIS_myco[1]))) 
#define the final tree for mycorrhiza
tips_to_drop_myco <- setdiff(tree$tip.label, keep_tips_myco)
tree_myco <- drop.tip(tree, tips_to_drop_myco)
```

### Add the binary trait state to the GIS table
```{r add binary state to GIS table}
#make new tables for both mycorrhiza states separately 
GIS_myco_0 <- myco_tsv[myco_tsv$myco_state_int == "0",]
GIS_myco_1 <- myco_tsv[myco_tsv$myco_state_int == "1",]

#add a column to GIS_myco that contains the binary trait values
GIS_myco$mycorrhiza[GIS_myco$allmb_name %in% GIS_myco_0$allmb_name] <- "0"
GIS_myco$mycorrhiza[GIS_myco$allmb_name %in% GIS_myco_1$allmb_name] <- "1"

#change order of the columns for esthetics
GIS_myco <- GIS_myco[,c(1,43, 2:42)]

#there are less plants in this GIS file than in the tree or the tsv file, this makes sense as there
#are not enough occurrences for each plant in the ALLMB tree. 
```

## 6 Correct for colinearity in the predictor variables

There will probably be some colinearity in the GIS-data. This could lead to instability and bias in the model, 
so a correction will have to be done. This can be done using the variance inflation factor (of the usdm package)
or a correlation matrix. See the VIF_analysis_myco file for details of the decision making process.

### VIF-analysis
```{r VIF analysis}
#load required package
library(usdm)

#fill in the arguments of the function and execute it 
vif(GIS_myco[,c(3:43)])

#choose the variables to delete that have a higher VIF value than 10, but make sure it makes sense in terms of biology, results in:
# 1. Without embergerQ
vif(GIS_myco[,c(3:5, 7, 14, 20, 22:24, 26, 28, 39, 42, 43)])

# 2. With embergerQ
vif(GIS_myco[,c(3:5, 7, 10, 14, 20, 22:24, 26, 28, 39, 42)])
```

## 7 Model selection: Define formula and select model 

The linear model will have to be made, with the trait-presence-column as the dependent variable, and the 
GIS data frames as the predictor variables. The function phylostep of the phylolm package will be used. 

### Define formulas
```{r define formula}
# 0. Define starting formula
myco_starting_formula <- mycorrhiza ~ 1 

# 1. Best formula

```

### Model selection 
What gives us the best result (in terms of the AIC value): 
- Model: BM, OUrandomRoot, or OUfixedRoot
- Direction: forward or both 
For full script and outcomes of the selection process, see "Model_selection_myco"
```{r model selection BM}
#load required package
library(phylolm)

#define function components and run function 
phylostep(formula = ??? , starting.formula = myco_starting_formula, data = GIS_myco, phy = tree_myco, model = "???", direction = "???", trace = 2)
```

## 8 Phylogenetic generalized linear modelling analysis

After this, the phylogenetic generalized linear modeling analysis will be done, which optimizes the model. 
There is a function in the phylolm package that allows us to do this: phyloglm. 

```{r phylogenetic generalized linear modelling}
#fill in the arguments for the phyloglm function and execute it
phyloglm(formula = , data = GIS_myco, phy = tree_myco, method = , btol = , log.alpha.bound = , start.beta = , start.alpha = , boot = , full.matrix = )
```

## 9 Biological interpretation

In the end, the final models and the predictor variables that are included will have to be interpreted biologically. 
With this knowledge, the thesis can be completed. 

