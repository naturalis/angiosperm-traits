---
title: "Pipeline_crops"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Pipeline of the necessary steps in R and outside of R

## 1 Import data

First the traits table and the original phylogeny (tree) have to be read into R in the right format to be able to use them. 

### The project root and the main tree
```{r define data root and import tree}
#load required package
library(ape)

#import and define data
project_root <- 'C:/Users/Esther/Documents/Master/Stage/'
tree_file <- paste(c(project_root, 'ALLMB.tre'), collapse = '')
tree <- read.tree(tree_file)
```

### Import domestication data 
```{r import domestication data}
#define trait table 
crops_tsv_file <- paste(c(project_root, 'sdmdl-angiosperm-data/data/crops.tsv'), collapse = '')
crops_tsv <- read.table(crops_tsv_file, sep = '\t', header = TRUE)
```

## 2 Recode dependent variables to binary form

The data of the dependent characters (the plant traits) have to be recoded. This is because a binary 
input is prefered for this analysis due to technical reasons. BUt at the moment, the three plant traits 
all have 3 or 4 states.
For domestication, there are 3 trait-states: progenitor of domesticated (1), only domesticated (2) 
and semi-domesticated (3). This will be turned into: progenitor of domesticated and semi-domesticated 
together (1). This eliminates the species that just exist in their domesticated form, which have 
already been altered by human selection, so they can't tell us anything about pre-adaptations.

### Cut out state 2 and combine state 1 and 3 
```{r cut out state 2}
#cut out all the plants that have trait state 2 from the tsv file 
crops_1_3 <- subset(crops_tsv, (crops_tsv$domestication == 1 | crops_tsv$domestication == 3))

#combine states 1 and 3
crops_1_3$domestication_binary[crops_1_3$domestication == "1"] <- "1"
crops_1_3$domestication_binary[crops_1_3$domestication == "3"] <- "1"
```

### Add state 0 
The domestication database is not complete yet, some non-domesticated plants have to be added to 
serve as the 0 state. These plants will come from the main tree, based on their distance on the
pylogeny to the plants already included in the domestication traits table. 

A. Import the right GIS data and make a GIS tree: 
```{r import GIS data}
#import GIS data 
GIS_file <- paste(c(project_root, 'niche_traits_merged.csv'), collapse = '')
GIS <- read.table(GIS_file, sep = ',', header = TRUE)

#change names of GIS data 
library(stringi)
GIS_names <- as.character(unlist(c(GIS[1])))
GIS_names <- gsub('  ', '. ', GIS_names)
GIS_names <- stri_replace_all_charclass(GIS_names, "\\p{WHITE_SPACE}", "_")
#there is a discrepancy with several names that should have a - instead of a _ in some places. 

#change those specific GIS names:
GIS_names[GIS_names == "Acaena_novae_zelandiae"] <- "Acaena_novae-zelandiae"
GIS_names[GIS_names == "Impatiens_noli_tangere"] <- "Impatiens_noli-tangere"  
GIS_names[GIS_names == "Myrrhidendron_donnell_smithii" ] <- "Myrrhidendron_donnell-smithii" 
GIS_names[GIS_names == "Silene_flos_cuculi"] <- "Silene_flos-cuculi"
GIS_names[GIS_names == "Pithecellobium_unguis_cati"] <- "Pithecellobium_unguis-cati"
GIS_names[GIS_names == "Hyacinthoides_non_scripta" ] <- "Hyacinthoides_non-scripta" 
GIS_names[GIS_names == "Alisma_plantago_aquatica"] <- "Alisma_plantago-aquatica" 
GIS_names[GIS_names == "Apera_spica_venti"] <- "Apera_spica-venti"
GIS_names[GIS_names == "Arctostaphylos_uva_ursi"] <- "Arctostaphylos_uva-ursi"
GIS_names[GIS_names == "Blitum_bonus_henricus"] <- "Blitum_bonus-henricus"
GIS_names[GIS_names == "Begonia_meyeri_johannis"] <- "Begonia_meyeri-johannis"
GIS$allmb_name <- GIS_names

#make the selection
tips_to_drop_GIS <- setdiff(tree$tip.label, GIS_names)
GIS_tree <- drop.tip(tree, tips_to_drop_GIS)

#are there still names that do not match?
nomatch_GIS_tree <- setdiff(GIS_names, GIS_tree$tip.label)
print(nomatch_GIS_tree)
#yes there is one name that is in the GIS table but not in the GIS tree: "Zea_mays_subsp._parviglumis". This is a wild subspecies of Zea mays, so it has the same distances to the other species as Zea mays does. 

#change the name of this subspecies to Zea_mays
GIS_names[GIS_names == "Zea_mays_subsp._parviglumis"] <- "Zea_mays"
GIS$allmb_name <- GIS_names

#check if the names match now
tips_to_drop_GIS <- setdiff(tree$tip.label, GIS_names)
GIS_tree <- drop.tip(tree, tips_to_drop_GIS)
nomatch_GIS_tree <- setdiff(GIS_names, GIS_tree$tip.label)
print(nomatch_GIS_tree)
#all names match!

#change the name in the crops_1_3 file as well
crops_1_3$allmb_name[crops_1_3$allmb_name == "Zea_mays_subsp._parviglumis"] <- "Zea_mays"
```

#### B. Tidy data
The tree and the traits-tables have to match, but there are plants in the phylogeny (tree) that are 
not in the traits table -> cut these out of the tree. It could be true that the taxa names don't 
match between the tree file and the trait-table, in that case not the same amount of taxa will still
be in the tree as there are in the trait table. If that is the case, this has to be fixed!
```{r trim tree}
#define the temporary tree for domestication out of the GIS tree
keep_tips_crops_1_3 <- as.character(unlist(c(crops_1_3[1]))) 
tips_to_drop_crops <- setdiff(GIS_tree$tip.label, keep_tips_crops_1_3)
tree_crops_tsv <- drop.tip(GIS_tree, tips_to_drop_crops)

#make a vector of the taxa names that are still in the tree
crops_names <- as.character(unlist(c(tree_crops_tsv$tip.label)))

#there are only 34 taxa in this tree, which is less than in the original tree and the tsv file, this makes sense as it could be the case that there are not enough occurrences for each plant in the ALLMB tree, and thus not enough GIS data.
```

#### C. Now do the distance matrix calculations
```{r distance matrix calculations}
#make a patristic distance matrix, this shows the phylogenetic distances between all the species in the tree
distances <- cophenetic.phylo(GIS_tree)

#print the 34 taxa names that all have state 1
print(crops_names)

#search for a non-domesticated species (state 0) inside the matrix for every printed species (state 1) name above, 
#sort the results based on the phylogenetic distance, and print the first 30 results
head(sort(distances[,colnames(distances) == crops_names[26]]), n=30) 

#choose the one that has the shortest phylogenetic distance AND is not domesticated (use internet to make sure) AND is not in the crops_names list -> add it to a new vector
#do this for [1] to [34], make sure the other new taxa you select are not already in the new vector.  

#1 Euphorbia_usambarica                       		#2 Calycophysum_pedunculatum
#3 Ibervillea_sonorae	                        		#4 Psiguria_triphylla
#5 Gurania_eriantha	                           		#6 Doyerea_emetocathartica
#7 Ficus_pandurata                             		#8 Fissicalyx_fendleri
#9 Dendrosida_sharpiana_subsp._pubescens       		#10 Ipomoea_arborescens
#11 Heliconia_psittacorum                     		#12 Tradescantia_zebrina
#13 Amischotolype_hispida                   	  	#14 Scleria_gaertneri
#15 Festuca_arundinacea_subsp._orientalis   	  	#16 Pogonarthria_squarrosa
#17 Digitaria_ischaemum                        		#18 Digitaria_violascens
#19 Elymus_repen					  			              	#20 Aegilops_cylindrica                    
#21 Aegilops_crassa						              			#22 Elymus_elongatus                        
#23 Poa_colensoi								                	#24 Molineria_capitulata                      
#25 Polygonatum_verticillatum				          		#26 Epipactis_helleborine                   
#27 Evodianthus_funifer							            	#28 Schoenoplectus_pungens_var._badius      
#29 Helictotrichon_desertorum_subsp._basalticum		#30 Eleocharis_acutangula_subsp._breviseta  
#31 Raddiella_esenbeckii					            		#32 Dienia_ophrydis                         
#33 Arum_maculatum							              		#34 Calla_palustris

allmb_name <- c("Euphorbia_usambarica", "Calycophysum_pedunculatum", "Ibervillea_sonorae", "Psiguria_triphylla", "Gurania_eriantha", "Doyerea_emetocathartica", "Ficus_pandurata", "Fissicalyx_fendleri", "Dendrosida_sharpiana_subsp._pubescens", "Ipomoea_arborescens", "Heliconia_psittacorum", "Tradescantia_zebrina", "Amischotolype_hispida", "Scleria_gaertneri", "Festuca_arundinacea_subsp._orientalis", "Pogonarthria_squarrosa", "Digitaria_ischaemum", "Digitaria_violascens", "Elymus_repen", "Aegilops_cylindrica", "Aegilops_crassa", "Elymus_elongatus", "Poa_colensoi", "Molineria_capitulata", "Polygonatum_verticillatum", "Epipactis_helleborine", "Evodianthus_funifer", "Schoenoplectus_pungens_var._badius", "Helictotrichon_desertorum_subsp._basalticum", "Eleocharis_acutangula_subsp._breviseta", "Raddiella_esenbeckii", "Dienia_ophrydis", "Arum_maculatum", "Calla_palustris")

#create a new dataframe for the state 0 taxa, and add columns that correspond with the ones in crops_1_3
crops_state0 <- data.frame(allmb_name)
crops_state0$gbif_species_key <- "NA"
crops_state0$domestication <- "0"
crops_state0$progenitor_of <- "NA"
crops_state0$domestication_binary <- "0"

#combine the two dataframes into one new complete dataframe 
crops_bi <- rbind(crops_1_3, crops_state0)  
```

## 5 Combine the data

The trait states, the selected subset of taxa names, and the GIS information all have to be combined into one file. 

### Tidy data
Make the right selection of taxa out of the GIS variables table and the tree. 
```{r trim the GIS table}
#select the taxa that should be kept in the GIS file
keep_GIS_crops <- as.character(unlist(c(crops_bi[1]))) 
#define the final GIS file for domestication
GIS_crops <- GIS[GIS$allmb_name %in% keep_GIS_crops,]

#select the names that have to be kept in the tree
keep_tips_crops <- as.character(unlist(c(GIS_crops[1]))) 
#define the final tree for domestication
tips_to_drop_crops <- setdiff(tree$tip.label, keep_tips_crops)
tree_crops <- drop.tip(tree, tips_to_drop_crops)
```

### Add the binary trait state to the GIS table
```{r add binary state to GIS table}
#make new tables for both domestication states separately 
GIS_crops_1 <- crops_1_3[crops_1_3$allmb_name %in% GIS$allmb_name,]
GIS_crops_0 <- crops_state0[crops_state0$allmb_name %in% GIS$allmb_name,]

#add column to GIS_crops and add domestication state
GIS_crops$domestication[GIS_crops$allmb_name %in% GIS_crops_1$allmb_name] <- "1"
GIS_crops$domestication[GIS_crops$allmb_name %in% GIS_crops_0$allmb_name] <- "0"

#change order of the columns for esthetics
GIS_crops <- GIS_crops[,c(1,43, 2:42)]

#there are less plants in this GIS file than in the tree or the tsv file, this makes sense as it could be the case that there are not enough occurrences for each plant in the ALLMB tree, and thus not enough GIS data.
```

## 6 Correct for colinearity in the predictor variables

There will probably be some colinearity in the GIS-data. This could lead to instability and bias in the model, 
so a correction will have to be done. This can be done using the variance inflation factor (of the usdm package)
or a correlation matrix. 
Only the combinations that result in the best models are shown, see VIF_analysis_crops" for all the used combinations. 

### VIF-analysis
```{r VIF analysis}
#load required package
library(usdm)

#fill in the arguments of the function and execute it 
vif(GIS_crops[,c(3:43)])

#choose a variable to delete that has a higher VIF value than 10, but make sure it makes sense in terms of biology, resulting in:
# 10a. With aridityIndexThornthwaite
vif(GIS_crops[,c(3:5, 7, 9, 14, 19, 20, 22:24, 37, 43)]) 

# 35. With monthCountByTemp10
vif(GIS_crops[,c(3:5, 14, 15, 19, 20, 22:24, 37, 38, 43)]) 
```

## 7 Model selection: Define input formulas and perform model selection 

The linear model will have to be made, with the trait-presence-column as the dependent variable, and the 
GIS data frames as the predictor variables. The function phylostep of the phylolm package will be used. 

### Define input formulas
Define the formulas that will be used as input formula in the phylostep function, based on the results of the VIF analysis. 
Only the formulas that result in the best models are shown, see "Model_selection_crops_elaborated" for all the used formulas. 
```{r define formula}
# 0. Define starting formula
crops_starting_formula <- domestication ~ 1 

# 10a. With aridityIndexThornthwaite
crops_formula_11a <- domestication ~ Aspect + BulkDensity + ClayPercentage + aridityIndexThornthwaite + continentality + minTempWarmest + PETWarmestQuarter + PETWettestQuarter + OrganicCarbon + PhCaCL + Slope + bio13 + bio19

# 35. With monthCountByTemp10
crops_formula_18 <- domestication ~ Aspect + BulkDensity + ClayPercentage + minTempWarmest + monthCountByTemp10 + PETWarmestQuarter + PETWettestQuarter + OrganicCarbon + PhCaCL + Slope + bio13 + bio14 + bio19
```

### Change data to match the wanted data format
There are some flaws in the GIS data frame that make it unfit for the phylostep function. First of all
the row names have to match the tip.lables of the tree, and secondly the trait value (0/1) has to be
seen as a numeric value. 
```{r}
#make allmb_name column into the row names of this table
rownames(GIS_crops) <- GIS_crops[,1]
GIS_crops[,1] <- NULL

#make sure the values in the 'woody' column are seen as numeric values
GIS_crops$domestication <- as.numeric(GIS_crops$domestication)
#check whether it worked
is.numeric(GIS_crops$domestication)
```

### Perform model selection 
What formula gives us the best result (in terms of the AIC value)?
```{r model selection}
#load required package
library(phylolm)

#define function components and run function, while changing:
  # - formula: all input formulas 
  # - model: BM, OUrandomRoot, or OUfixedRoot
  # - direction: forward or both

#BM, both: define formula components and run function 
phylostep(formula = crops_formula_11a, starting.formula = crops_starting_formula, data = GIS_crops, phy = tree_crops, model = "BM", direction = "both", trace = 2)

#OUfixedRoot, both: define formula components and run function 
phylostep(formula = crops_formula_18, starting.formula = crops_starting_formula, data = GIS_crops, phy = tree_crops, model = "OUfixedRoot", direction = "both", trace = 2, lower.bound = 0.001, upper.bound = 1000)
```

What gives us the best result (in terms of the AIC value)?  
- Formula: which input formula 
- Model: BM or OUfixedRoot
- Direction: both 
- Model: what is the best model you get 

### Define best models
```{r}
# BM
domestication_BM <- domestication ~ 0.2718999 + 0.7254957*Aspect + 0.4467063*ClayPercentage + 0.4136109*PhCaCL + 0.2569151*Slope 

# OUfixedRoot
domestication_OU <- domestication ~ 0.2812481 + 0.7397210*Aspect -0.2509282*BulkDensity + 0.4460845*ClayPercentage + 0.3330660*PhCaCL + 0.1744375*Slope
```

## 7 Model evaluation

To see whether the best model we constructed, is still in compliance with the assumptions that have to be met when performing a GLM. There is a package that can do this for you, called 'performance'. We'll do a comprehensive model check, with function 'check_model()'
```{r}
#install and load required package 
install.packages("performance")
install.packages("see")
library(performance)
library(see)

#BM
model <- glm(model = domestication_BM, data = )
check_model(model)

#OU
model <- glm(model = domestication_OU, data = )
check_model(model)
```

1. Check for multicolinearity
2. Non-normality of residuals and outliers
3. Non-normality of residuals
4. Homoscedasticity (linear relationship)
5. Homogeneity of variance (scale-location)
6. Check for influential observations

## 8 Phylogenetic generalized linear modelling analysis

After this, the phylogenetic generalized linear modeling analysis will be done, which optimizes the model. 
There is a function in the phylolm package that allows us to do this: phyloglm. 

```{r phylogenetic generalized linear modelling}
#fill in the arguments for the phyloglm function and execute it
phyloglm(formula = , data = GIS_crops, phy = tree_crops, method = , btol = , log.alpha.bound = , start.beta = , start.alpha = , boot = , full.matrix = )
```

## 9 Biological interpretation

In the end, the final models and the predictor variables that are included will have to be interpreted biologically. 
With this knowledge, the thesis can be completed. 
