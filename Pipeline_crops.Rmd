---
title: "Pipeline_crops"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Pipeline of the necessary steps in R and outside of R

## 1 Import data

First the traits table and the original tree have to be read into R in the right format to be able to use them. 

### The project root and the main tree
```{r define data root and import tree}
#load required package
library(ape)

#import and define data
project_root <- 'C:/Users/Esther/Documents/Master/Stage/'
tree_file <- paste(c(project_root, 'ALLMB.tre'), collapse = '')
tree <- read.tree(tree_file)
```

### Import domestication data 
```{r import domestication data}
#define trait table 
crops_tsv_file <- paste(c(project_root, 'sdmdl-angiosperm-data/data/crops.tsv'), collapse = '')
crops_tsv <- read.table(crops_tsv_file, sep = '\t', header = TRUE)
```

## 3 Recode dependent variables to binary form

The data of the dependent characters (the plant traits) have to be recoded. This is because a binary 
input is prefered for this analysis due to technical reasons, while all the data has 3 or 4 states at the
moment. 

### Cut out state 2

For domestication, there are 3 trait-states: progenitor of domesticated (1), only domesticated (2) 
and semi-domesticated (3). 
This will be turned into: progenitor of domesticated and semi-domesticated together (1). This 
eliminates the species that just exist in their domesticated form, which have already been altered 
by human selection, so they can't tell us anything about pre-adaptations. 
```{r cut out state 2}
#cut out all the plants that have trait state 2 from the tsv file 
crops_tsv_1_3 <- subset(crops_tsv, (crops_tsv$domestication == 1 | crops_tsv$domestication == 3))

#combine states 1 and 3
crops_tsv_1_3$domestication_binary[crops_tsv_1_3$domestication == "1"] <- "1"
crops_tsv_1_3$domestication_binary[crops_tsv_1_3$domestication == "3"] <- "1"
```

### Add state 0 
The domestication database is not complete yet, some non-domesticated plants have to be added to 
serve as the 0 state. These plants will come from the main tree, based on their distance on the
pylogeny to the plants already included in the domestication traits table. 

#### A. Import the right GIS data and make a GIS tree: 
```{r import GIS data}
#import GIS data 
GIS_file <- paste(c(project_root, 'niche_traits_merged.csv'), collapse = '')
GIS <- read.table(GIS_file, sep = ',', header = TRUE)

#change names of GIS data 
library(stringi)
GIS_names <- as.character(unlist(c(GIS[1])))
GIS_names <- gsub('  ', '. ', GIS_names)
GIS_names <- stri_replace_all_charclass(GIS_names, "\\p{WHITE_SPACE}", "_")

#there is a discrepancy with several names that should have a - instead of a _ in some places. 
#So we have to change those specific GIS names:
GIS_names[GIS_names == "Acaena_novae_zelandiae"] <- "Acaena_novae-zelandiae"
GIS_names[GIS_names == "Impatiens_noli_tangere"] <- "Impatiens_noli-tangere"  
GIS_names[GIS_names == "Myrrhidendron_donnell_smithii" ] <- "Myrrhidendron_donnell-smithii" 
GIS_names[GIS_names == "Silene_flos_cuculi"] <- "Silene_flos-cuculi"
GIS_names[GIS_names == "Pithecellobium_unguis_cati"] <- "Pithecellobium_unguis-cati"
GIS_names[GIS_names == "Hyacinthoides_non_scripta" ] <- "Hyacinthoides_non-scripta" 
GIS_names[GIS_names == "Alisma_plantago_aquatica"] <- "Alisma_plantago-aquatica" 
GIS_names[GIS_names == "Apera_spica_venti"] <- "Apera_spica-venti"
GIS_names[GIS_names == "Arctostaphylos_uva_ursi"] <- "Arctostaphylos_uva-ursi"
GIS_names[GIS_names == "Blitum_bonus_henricus"] <- "Blitum_bonus-henricus"
GIS_names[GIS_names == "Begonia_meyeri_johannis"] <- "Begonia_meyeri-johannis"
GIS$allmb_name <- GIS_names

#make the selection
tips_to_drop_GIS <- setdiff(tree$tip.label, GIS_names)
GIS_tree <- drop.tip(tree, tips_to_drop_GIS)

#are there still names that do not match?
nomatch_tree_GIS <- setdiff(GIS_names, GIS_tree$tip.label)
print(nomatch_tree_GIS)

#yes there is one name that is in the GIS table but not in the GIS tree: "Zea_mays_subsp._parviglumis"
#this is a wild subspecies of Zea mays, so it has the same distances to the other species as Zea mays does. 

#change the name of this subspecies to Zea_mays, otherwise there will be miscommunication during the model selction
GIS_names[GIS_names == "Zea_mays_subsp._parviglumis"] <- "Zea_mays"
GIS$allmb_name <- GIS_names

#check if the names match now
tips_to_drop_GIS <- setdiff(tree$tip.label, GIS_names)
GIS_tree <- drop.tip(tree, tips_to_drop_GIS)
nomatch_tree_GIS <- setdiff(GIS_names, GIS_tree$tip.label)
print(nomatch_tree_GIS)

#all names match!

#now change the name in the crops_tsv_1_3 file as well, so that the selection later on goes well
crops_tsv_1_3$allmb_name[crops_tsv_1_3$allmb_name == "Zea_mays_subsp._parviglumis"] <- "Zea_mays"
```

#### B. Tidy data
The tree and the traits-tables have to match, but there are plants in the phylogeny (tree) that are 
not in the traits table -> cut these out of the tree. It could be true that the taxa names don't 
match between the tree file and the trait-table, in that case not the same amount of taxa will still
be in the tree as there are in the trait table. If that is the case, this has to be fixed!
```{r trim tree}
#define the temporary tree for domestication out of the GIS tree
keep_tips_crops_tsv_bi <- as.character(unlist(c(crops_tsv_1_3[1]))) 
tips_to_drop_crops <- setdiff(GIS_tree$tip.label, keep_tips_crops_tsv_bi)
tree_crops_temp <- drop.tip(GIS_tree, tips_to_drop_crops)

#make a vector of the taxa names that are still in the tree
crops_names <- as.character(unlist(c(tree_crops_temp$tip.label)))
```

#### C. Now do the distance matrix calculations
```{r distance matrix calculations}
#make a patristic distance matrix 
distances <- cophenetic.phylo(GIS_tree)

#search for a progenitor/semi-domesticated species inside the matrix, select the species in the matrix that has the shortest distance and add it to the vector
print(crops_names)
head(sort(distances[,colnames(distances) == crops_names[1]]), n=20) #repeat this for 1-33
#1 Euphorbia_usambarica                     #2 Calycophysum_pedunculatum
#3 Solena_heterophylla                      #4 Cucumis_myriocarpus
#5 Coccinia_adoensis                        #6 Coccinia_grandis
#7 Morus_alba                               #8 Arachis_hypogaea_var._peruviana
#9 Pistacia_lentiscus                       #10 Ipomoea_batatas
#11 Heliconia_psittacorum                   #12 Tradescantia_zebrina
#13 Amischotolype_hispida                   #14 Oenocarpus_bataua
#15 Festuca_arundinacea_subsp._orientalis   #16 Pogonarthria_squarrosa
#17 Setaria_glauca                          #18 Digitaria_violascens
#19 Hordeum_vulgare_subsp._vulgare
#20 Aegilops_cylindrica                     #21 Aegilops_crassa
#22 Elymus_elongatus                        #23 Microlaena_stipoides
#24 Dioscorea_communis                      #25 Tacca_chantrieri
#26 Freycinetia_banksii                     #27 Evodianthus_funifer
#28 Schoenoplectus_pungens_var._badius      #29 Helictotrichon_desertorum_subsp._basalticum
#30 Eleocharis_acutangula_subsp._breviseta  #31 Raddiella_esenbeckii
#32 Dienia_ophrydis                         #33 Arum_maculatum
#34 Calla_palustris
head(sort(distances[,colnames(distances) == crops_names[33]]), n=20)

#define a new vector with the 33 new taxa names 
allmb_name <- c("Euphorbia_usambarica", "Calycophysum_pedunculatum", "Solena_heterophylla", "Cucumis_myriocarpus", "Coccinia_adoensis", "Coccinia_grandis", "Morus_alba", "Arachis_hypogaea_var._peruviana", "Pistacia_lentiscus", "Ipomoea_batatas", "Heliconia_psittacorum", "Tradescantia_zebrina", "Amischotolype_hispida", "Oenocarpus_bataua", "Festuca_arundinacea_subsp._orientalis", "Pogonarthria_squarrosa", "Setaria_glauca", "Digitaria_violascens", "Hordeum_vulgare_subsp._vulgare", "Aegilops_cylindrica", "Aegilops_crassa", "Elymus_elongatus", "Microlaena_stipoides", "Dioscorea_communis", "Tacca_chantrieri", "Freycinetia_banksii", "Evodianthus_funifer", "Schoenoplectus_pungens_var._badius", "Helictotrichon_desertorum_subsp._basalticum", "Eleocharis_acutangula_subsp._breviseta", "Raddiella_esenbeckii", "Dienia_ophrydis", "Arum_maculatum", "Calla_palustris")

#create a new dataframe and add columns corresponding with crops_tsv_1_3
crops_df_state0 <- data.frame(allmb_name)
crops_df_state0$gbif_species_key <- "NA"
crops_df_state0$domestication <- "0"
crops_df_state0$progenitor_of <- "NA"
crops_df_state0$domestication_binary <- "0"

#combine the two dataframes into one new dataframe 
crops_tsv_bi <- rbind(crops_tsv_1_3, crops_df_state0)  
```

```{r distance matrix in code}
#Trying to do it in code:
library(dplyr)
distances_2 <- head(sort(distances[,colnames(distances) == crops_names[2]]))

nth(head(sort(distances[,colnames(distances) == crops_names[2]])), 2)

print(row.names(nth(head(sort(distances[,colnames(distances) == crops_names[2]])), 2)))

```

## 5 Combine the data

The trait states, the selected subset of taxa names, and the GIS information all have to be combined into one file. 

### Tidy data
Make the right selection of taxa out of the GIS variables table. 
```{r trim the GIS table}
#define the final tree for domestication
keep_tips_crops_tsv_bi <- as.character(unlist(c(crops_tsv_bi[1]))) 
keep_tips_crops_tsv_bi <- stri_replace_all_charclass(keep_tips_crops_tsv_bi, "\\p{WHITE_SPACE}", "_")
tips_to_drop_crops <- setdiff(tree$tip.label, keep_tips_crops_tsv_bi)
tree_crops <- drop.tip(tree, tips_to_drop_crops)

#define the taxa that should be selected from the GIS file
keep_GIS_crops <- as.character(unlist(c(crops_tsv_bi[1]))) 

#make the selection in the GIS file
GIS_crops <- GIS[GIS$allmb_name %in% keep_GIS_crops,]
```

### Add the binary trait state to the GIS table
```{r add binary state to GIS table}
#make new tables for both domestication states separately 
GIS_crops_1 <- crops_tsv_1_3[crops_tsv_1_3$allmb_name %in% GIS$allmb_name,]
GIS_crops_0 <- crops_df_state0[crops_df_state0$allmb_name %in% GIS$allmb_name,]

#add column to GIS_crops and add domestication state
GIS_crops$domestication[GIS_crops$allmb_name %in% GIS_crops_1$allmb_name] <- "1"
GIS_crops$domestication[GIS_crops$allmb_name %in% GIS_crops_0$allmb_name] <- "0"

#change order of the columns for esthetics
GIS_crops <- GIS_crops[,c(1,43, 2:42)]

#there are less plants in this GIS file than in the tree or the tsv file, this makes sense as there
#are not enough occurrences for each plant in the ALLMB tree. 
```

## 6 Correct for colinearity in the predictor variables

There will probably be some colinearity in the GIS-data. This could lead to instability and bias in the model, 
so a correction will have to be done. This can be done using the variance inflation factor (of the usdm package)
or a correlation matrix. 

### VIF-analysis
```{r VIF analysis}
#load required package
library(usdm)

#fill in the arguments of the function and execute it 
vif(GIS_crops)

#choose a variable to delete that has a higher VIF value than 10, but make sure it makes sense in terms of biology 
```

## 7 Model selection: Define formula and select model 

The linear model will have to be made, with the trait-presence-column as the dependent variable, and the 
GIS data frames as the predictor variables. The function phylostep of the phylolm package will be used. 

```{r model selection BM}
#load required package
library(phylolm)

#define formula components and run function (forward)
phylostep(formula = , starting.formula = domestication ~ 1, data = GIS_crops, phy = tree_crops, model = "BM", direction = "forward", trace = 2)

#define formula components and run function (both)
phylostep(formula = , starting.formula = domestication ~ 1, data = GIS_crops, phy = tree_crops, model = "BM", direction = "both", trace = 2)
```

```{r model selection OUrandomRoot}
#load required package
library(phylolm)

#define formula components and run function (forward)
phylostep(formula = , starting.formula = domestication ~ 1, data = GIS_crops, phy = tree_crops, model = "OUrandomRoot", direction = "forward", trace = 2)

#define formula components and run function (both)
phylostep(formula = , starting.formula = domestication ~ 1, data = GIS_crops, phy = tree_crops, model = "OUrandomRoot", direction = "both", trace = 2)
```

```{r model selection OUfixedRoot}
#load required package
library(phylolm)

#define formula components and run function (forward)
phylostep(formula = , starting.formula = domestication ~ 1, data = GIS_crops, phy = tree_crops, model = "OUfixedRoot", direction = "forward", trace = 2)

#define formula components and run function (both)
phylostep(formula = , starting.formula = domestication ~ 1, data = GIS_crops, phy = tree_crops, model = "OUfixedRoot", direction = "both", trace = 2)
```

## 8 Phylogenetic generalized linear modelling analysis

After this, the phylogenetic generalized linear modeling analysis will be done, which optimizes the model. 
There is a function in the phylolm package that allows us to do this: phyloglm. 

```{r phylogenetic generalized linear modelling}
#fill in the arguments for the phyloglm function and execute it
phyloglm(formula = , data = GIS_crops, phy = tree_crops, method = , btol = , log.alpha.bound = , start.beta = , start.alpha = , boot = , full.matrix = )
```

## 9 Biological interpretation

In the end, the final models and the predictor variables that are included will have to be interpreted biologically. 
With this knowledge, the thesis can be completed. 
