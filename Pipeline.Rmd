---
title: "Pipeline"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Pipeline of the necessary steps in R and outside of R

## 1 Import data

First the traits table and the original tree have to be read into R in the right format to be able to use them. 

### The main tree
```{r import tree}
project_root <- 'C:/Users/Esther/Documents/Master/Stage/'
tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
```


### Secondary woodiness
```{r import secondary woodiness}
#load required package
library(ape)
#define trait tables
woody_nex_file <- paste(c(project_root, 'sdmdl-angiosperm-data/data/woody.nex'), collapse = '')
woody_nex <- read.nexus(woody_nex_file)

woody_tsv_file <- paste(c(project_root, 'sdmdl-angiosperm-data/data/woody.tsv'), collapse = '')
woody_tsv <- read.table(woody_tsv_file, sep = '\t', header = TRUE)
  
```

### Mycorrhiza
```{r import mycorrhiza}
#load required package
library(ape)
#define trait table 
myco_nex_file <- paste(c(project_root, 'sdmdl-angiosperm-data/data/myco.nex'), collapse = '')
myco_nex <- read.nexus(myco_nex_file)

myco_tsv_file <- paste(c(project_root, 'sdmdl-angiosperm-data/data/myco.tsv'), collapse = '')
myco_tsv <- read.table(myco_tsv_file, sep = '\t', header = TRUE)
```

### Domestication 
```{r import domestication}
#load required package
library(ape)
#define trait table 
crops_tsv_file <- paste(c(project_root, 'sdmdl-angiosperm-data/data/crops.tsv'), collapse = '')
crops_tsv <- read.table(crops_tsv_file, sep = '\t', header = TRUE)
```

## 2 Recode dependent variables to binary form

The data of the dependent characters (the plant traits) have to be recoded. This is because a binary 
input is prefered for this analysis due to technical reasons, while all the data has 3 or 4 states at the
moment. 

### Secondary woodiness
For secondary woodiness, there are 3 trait-states: derived woody (0), non-woody (1), ancestral woody (2). 
This will be turned into: derived woody (0) and non-woody (1). As this is the actual shift between 
non-woody and derived woodiness. So all the plants with ancestral woodiness (3) as trait, have to be 
eliminated from the analysis. 
```{r}
#load required package 
library(ape)

#define trait table for swo
woody_nex

#load tsv file and make selection which to keep 
woody_tsv
woody_tsv_bi <- subset(woody_tsv, (woody_tsv$woody == 0 | woody_tsv$woody ==1))

#define the taxa that should not be included (with value 2)
woody_tsv_2 <- subset(woody_tsv, (woody_tsv$woody == 2)) 
unwanted_tips_woody <- as.character(unlist(c(woody_tsv_2[1]))) 
unwanted_tips_woody <- sub(" ", "_", unwanted_tips_woody) #to make the names the same as in the swo tree. 

#make the subset in the original woody.nex file 
woody_bi_wrong <- drop.tip(woody_nex, unwanted_tips_woody)
#the previous command yielded a wrong dataset (as the name already tells us), it seems like the names still 
#do not match completely, we'll have to fix that. For now this is a different solution that also works: 
unwanted_numbers_woody <- as.numeric(row.names(woody_tsv_2))

#make a subset of nex file with these taxa as condition and give new name 
#so define new sub-swo, which contains binary trait values
woody_bi <- drop.tip(woody_nex, unwanted_numbers_woody)

#save this file as a new file.
???

#the root edge is not present anymore in swo_bin, but that is okay. 
```


### Mycorrhiza
For mycorrhiza, there are 4 trait-states: EM, AM, both, neither. This will be turned into: AM (0) and 
the rest together (1). So in this case nothing will be eliminated from the analysis, just (1)(2)(3) have 
to be collapsed together. 
```{r}
#load required package
library(ape)
#define trait table 
myco_nex
myco_tsv

#combine all the plants that have 1/2/3 as trait states
myco_tsv_bin <- sub("2", "1", myco$charstatelabels)

#define new sub-myc, which contains binary trait values
myco_bi <- 

#save this file as a new file.
???
  
```

### Domestication
The domestication database is not complete yet, some non-domesticated plants have to be added to 
serve as the 0 state. These plants will come from the main tree, based on their distance on the
pylogeny to the plants already included in the domestication traits table. 
```{r}
#load domestication trait table and the tree

#make a sub-selection of the tree based on earlier selected plants (based on location in phylogeny)

#add this sub-selection of the tree to the domestication trait table 
crops_tsv_complete <- 
#add a 0 to the domesticated column for these new plants

```

Now, for domestication, there are 4 trait-states: non-domesticated (0), progenitor of domesticated (1), 
only domesticated (2) and semi-domesticated (3). 
This will be turned into: non-domesticated (0) and progenitor of domesticated and semi-domesticated 
together (1). This eliminates the species that just exist in their domesticated form, which have 
already been altered by human selection, so they can't tell us anything about pre-adaptations. 
```{r}
#load necessary packages and data 
library(ape)
crops_tsv_complete

#cut out all the plants that have trait state 2 from the tsv file 
crops_tsv_013 <- subset(crops_tsv, (crops_tsv$domestication == 0 | crops_tsv$domestication == 1))

#combine states 1 and 3


#define new sub-dom, which contains binary trait values
crops_tsv_bi <- 

#save this file as a new file.
???

```

## 3 Tidy data

The tree and the traits-table have to match, as there will be plants in the phylogeny that are not in the 
traits table -> cut these out of the tree. 

### Secondary woodiness
```{r match tips sec. wood.}
#load required packages and data
tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
woody_bi

#define the final tree for swo
tips_to_drop_woody <- setdiff(tree$tip.label, woody_bi$tip.label)
woody_final <- drop.tip(tree,tip=tips_to_drop_woody)

```

### Mycorrhiza 
```{r match tips myc.}
#load required packages and data
tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
myco_bi 

#define the final tree for myc
tips_to_drop_myco <- setdiff(tree$tip.label, myco_bi$tip.label)
myco_tree <- drop.tip(tree,tip=tips_to_drop_myco)

```

### Domestication 
```{r match tips dom.}

tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
crops_bi 

#define the final tree for dom
tips_to_drop_crops <- setdiff(tree$tip.label, crops_bi$tip.label)
crops_tree <- drop.tip(tree,tip=tips_to_drop_crops)

```

## 4 Correct for colinearity in the predictor variables

There will probably be some colinearity in the GIS-data. This could lead to instability and bias in the model, 
so a correction will have to be done. This can be done using the variance inflation factor (of the usdm package)
or a correlation matrix. 

### VIF-analysis
```{r}
# import GIS data 

#load sdm package
library(usdm)

#execute VIF function 

```

### Biological interpretation
For each of the separate research question, check whether the predictor variables that are still present and
not present anymore, still make sense in terms of biological interpretation. 


## 5 Model selection: Define formula and select model 

The linear model will have to be made, with the trait-presence-column as the dependent variable, and the 
GIS data frames as the predictor variables. The function phylostep of the phylolm package will be used. 

### Secondary woodiness
```{r}
#define formula components

#construct formula

```


### Mycorrhiza
```{r}
#define formula components

#construct formula

```


### Domestication
```{r}
#define formula components

#construct formula

```


## 6 Analysis

After this, the phylogenetic generalized linear modeling analysis will be done, which optimizes the model. 
There is a function in the phylolm package that allows us to do this: phyloglm. 

### Secondary woodiness
```{r}
#fill in the arguments for the phyloglm function and execute it

```


### Mycorrhiza
```{r}
#fill in the arguments for the phyloglm function and execute it

```


### Domestication
```{r}
#fill in the arguments for the phyloglm function and execute it

```


## 7 Biological interpretation

In the end, the final models and the predictor variables that are included will have to be interpreted biologically. 
With this knowledge, the thesis can be completed. 



