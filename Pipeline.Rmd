---
title: "Pipeline"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Pipeline of the necessary steps in R and outside of R

## 1 Import data

First the traits table and the original tree have to be read into R in the right format. 

### Secondary woodiness
```{r import secondary woodiness}
#load required package
library(ape)
#define trait table and original tree
swo <- read.nexus("C:/Users/Esther/Documents/Master/Stage/sdmdl-angiosperm-data/data/woody.nex")
tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
```

### Mycorrhiza
```{r import mycorrhiza}
#load required package
library(ape)
#define trait table and original tree
myc <- read.nexus("C:/Users/Esther/Documents/Master/Stage/sdmdl-angiosperm-data/data/myco.nex")
tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
```

### Domestication 
```{r import domestication}
#load required package
library(ape)
#define trait table and original tree
dom_incomplete <- read.table("C:/Users/Esther/Documents/Master/Stage/sdmdl-angiosperm-data/data/crops.tsv", header = T, sep = "\t")
tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
```

## 2 Recode dependent variables to binary form

The data of the dependent characters (the plant traits) have to be recoded. This is because a binary 
input is prefered for this analysis due to technical reasons, while all the data has 3 or 4 states at the
moment. 

### Secondary woodiness
For secondary woodiness, there are 3 trait-states: derived woody (0), non-woody (1), ancestral woody (2). 
This will be turned into: derived woody (0) and non-woody (1). As this is the actual shift between 
non-woody and derived woodiness. So all the plants with ancestral woodiness (3) as trait, have to be 
eliminated from the analysis. 
```{r}
#load required package 
library(ape)

#define trait table for swo
swo <- read.nexus("C:/Users/Esther/Documents/Master/Stage/sdmdl-angiosperm-data/data/woody.nex")

#load tsv file and make selection which to keep 
swo_tsv <- read.table(file = "C:/Users/Esther/Documents/Master/Stage/sdmdl-angiosperm-data/data/woody.tsv", sep = '\t', header = TRUE)
swo_tsv_bi <- subset(swo_tsv, (swo_tsv$woody == 0 | swo_tsv$woody ==1))

#define the taxa that should not be included (with value 2)
swo_tsv_2 <- subset(swo_tsv, (swo_tsv$woody == 2)) 
unwanted_tips_swo <- as.character(unlist(c(swo_tsv_2[1]))) 
unwanted_tips_swo <- sub(" ", "_", unwanted_tips_swo) #to make the names the same as in the swo tree. 

#make the subset in the original woody.nex file 
swo_bi_wrong <- drop.tip(swo, unwanted_tips_swo)

#the previous command yielded a wrong dataset (as the name already tells us), it seems like the names still 
#do not match completely, we'll have to fix that. For now this is a different solution that also works: 
unwanted_numbers_swo <- as.numeric(row.names(swo_tsv_2))

#make a subset of nex file with these taxa as condition and give new name 
#so define new sub-swo, which contains binary trait values
swo_bi <- drop.tip(swo, unwanted_numbers_swo)

#save this file as a new file.
???

#the root edge is not present anymore in swo_bin, but that is okay. 
```


### Mycorrhiza
For mycorrhiza, there are 4 trait-states: EM, AM, both, neither. This will be turned into: AM (0) and 
the rest together (1). So in this case nothing will be eliminated from the analysis, just (1)(2)(3) have 
to be collapsed together. 
```{r}
#combine all the plants that have 1/2/3 as trait states

#define new sub-myc, which contains binary trait values
myc_bi <- 

#save this file as a new file.
???
  
```

### Domestication
The domestication database is not complete yet, some non-domesticated plants have to be added to 
serve as the 0 state. These plants will come from the main tree, based on their distance on the
pylogeny to the plants already included in the domestication traits table. 
```{r}
#load domestication trait table and the tree

#make a sub-selection of the tree based on earlier selected plants (based on location in phylogeny)

#add this sub-selection of the tree to the domestication trait table 
dom <- 
#add a 0 to the domesticated column for these new plants

```

Now, for domestication, there are 4 trait-states: non-domesticated (0), progenitor of domesticated (1), 
only domesticated (2) and semi-domesticated (3). 
This will be turned into: non-domesticated (0) and progenitor of domesticated and semi-domesticated 
together (1). This eliminates the species that just exist in their domesticated form, which have 
already been altered by human selection, so they can't tell us anything about pre-adaptations. 
```{r}
#cut out the plants that have trait state 2
library(ape)
dom <- read.nexus("C:/Users/Esther/Documents/Master/Stage/sdmdl-angiosperm-data/data/...")
dom_tsv <- read.table(file = "C:/Users/Esther/Documents/Master/Stage/sdmdl-angiosperm-data/data/crops.tsv", sep = '\t', header = TRUE)
dom_tsv_2 <- subset(dom_tsv, (dom_tsv$domestication == 2))
unwanted_tips_dom <- as.character(unlist(c(dom_tsv_2[1])))
dom_0_1_3 <- drop.tip(dom, unwanted_tips_dom)

#combine states 1 and 3


#define new sub-dom, which contains binary trait values
dom_bi <- 

#save this file as a new file.
???

```

## 3 Tidy data

The tree and the traits-table have to match, as there will be plants in the phylogeny that are not in the 
traits table -> cut these out of the tree. 

### Secondary woodiness
```{r match tips sec. wood.}
#define sub-tree for swo
tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
swo_bi <- read.nexus("C:/...")
tips_to_drop_swo <- setdiff(tree$tip.label, swo_bi$tip.label)
swo_bi_sub <- drop.tip(tree,tip=tips_to_drop_swo)

```

### Mycorrhiza 
```{r match tips myc.}
#define sub-tree for myc
tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
myc_bi <- read.nexus("C:/...")
tips_to_drop_myc <- setdiff(tree$tip.label, myc_bi$tip.label)
myc_bi_sub <- drop.tip(tree,tip=tips_to_drop_myc)

```

### Domestication 
```{r match tips dom.}
#define sub-tree for dom
tree <- read.tree("C:/Users/Esther/Documents/Master/Stage/ALLMB.tre")
dom_bi <- read.nexus("C:/...")
tips_to_drop_dom <- setdiff(tree$tip.label, dom_bi$tip.label)
dom_bi_sub <- drop.tip(tree,tip=tips_to_drop_dom)

```

## 4 Correct for colinearity in the predictor variables

There will probably be some colinearity in the GIS-data. This could lead to instability and bias in the model, 
so a correction will have to be done. This can be done using the variance inflation factor (of the usdm package)
or a correlation matrix. 

### VIF-analysis
```{r}
# import GIS data 

#load sdm package
library(usdm)

#execute VIF function 

```

### Biological interpretation
For each of the separate research question, check whether the predictor variables that are still present and
not present anymore, still make sense in terms of biological interpretation. 


## 5 Model selection: Define formula and select model 

The linear model will have to be made, with the trait-presence-column as the dependent variable, and the 
GIS data frames as the predictor variables. The function phylostep of the phylolm package will be used. 

### Secondary woodiness
```{r}
#define formula components

#construct formula

```


### Mycorrhiza
```{r}
#define formula components

#construct formula

```


### Domestication
```{r}
#define formula components

#construct formula

```


## 6 Analysis

After this, the phylogenetic generalized linear modeling analysis will be done, which optimizes the model. 
There is a function in the phylolm package that allows us to do this: phyloglm. 

### Secondary woodiness
```{r}
#fill in the arguments for the phyloglm function and execute it

```


### Mycorrhiza
```{r}
#fill in the arguments for the phyloglm function and execute it

```


### Domestication
```{r}
#fill in the arguments for the phyloglm function and execute it

```


## 7 Biological interpretation

In the end, the final models and the predictor variables that are included will have to be interpreted biologically. 
With this knowledge, the thesis can be completed. 



